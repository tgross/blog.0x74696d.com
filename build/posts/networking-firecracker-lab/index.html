<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>0x74696d | Networking for a Firecracker Lab</title>
  <meta name="author" content="map[]" />
  <meta name="description" content="T-Minus 15.193792102158E&#43;9 years until the universe closes!" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
  
  <link rel="stylesheet" href="/css/base.css" type="text/css" media="all" />
  <link rel="stylesheet" href="/fonts/ss-social.css" type="text/css" />

</head>

<body>
  <div class="header">
    <div class="container">
      <section class="name">
        <a href="/"><b>0x74696d</b></a>
      </section>

      <ul class="menu">
        <li><a href="/">Posts</a></li>
        <li><a href="https://github.com/tgross?tab=repositories">Projects</a></li>
        <li><a href="/community/">Community</a></li>
        
      </ul>

    </div>
  </div>

<section class="container content">
  <h1>Networking for a Firecracker Lab</h1>
  <section class="byline">July 27, 2021</section>
  <p>Several of my personal projects require creating and destroying a lot
of virtual machines, so I've started porting them over from QEMU to
<a href="https://firecracker-microvm.github.io/">Firecracker</a> to speed up
development. I'm now at the point where I need to make some of these
VMs accessible from the internet and other machines on the LAN. My
scenario is that I have three physical machines (2 NUCs and my
development laptop) that act as virtual machine hosts. Some of them
are currently running services on QEMU virtual machines, which I
intend to migrate over to Firecracker eventually but I don't want a
flag day for migration.</p>
<p>The obvious question given that I was a
<a href="https://www.nomadproject.io/">Nomad</a> maintainer is why I wouldn't use
a Nomad <a href="https://github.com/cneira/firecracker-task-driver">Firecracker task
driver</a>, but it
turns out I'm not running a Nomad cluster across these machines. The
NUCs are powered off most of the day; if I happen to need them I fire
a wake-on-LAN to boot them and wait for their services to come
up. Nomad's control plane doesn't tolerate having peers offline for
extended periods of time, so it's just the wrong use case for this
home lab.</p>
<p><a href="https://gruchalski.com/about/">Radek Gruchalski</a> has a great series
(<a href="https://gruchalski.com/posts/2021-02-06-taking-firecracker-for-a-spin/">I</a>,
<a href="https://gruchalski.com/posts/2021-02-07-vault-on-firecracker-with-cni-plugins-and-nomad/">II</a>,
<a href="https://gruchalski.com/posts/2021-02-17-bridging-the-firecracker-network-gap/">III</a>)
where he explores Firecracker, tries it out with Nomad and CNI, and
gets bridge networking going after forking
<a href="https://github.com/firecracker-microvm/firectl"><code>firectl</code></a>. Gruchalski's
approach builds on top of a
<a href="https://jvns.ca/blog/2021/01/23/firecracker--start-a-vm-in-less-than-a-second/">post</a>
by the always-delightful Julia Evans
(<a href="https://twitter.com/b0rk">@b0rk</a>).</p>
<p>Evans configures the networking of the VM guests by passing boot
arguments (TIL! See also this section from the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-configuring_ip_networking_from_the_kernel_command_line">RHEL networking
guide</a>),
and creates the tuntap device in her script. Gruchalski instead uses
<a href="https://www.cni.dev/">Container Network Interface (CNI)</a> plugins to
create a bridge network, assign an IP, and create the required tuntap
device via the
<a href="https://github.com/awslabs/tc-redirect-tap"><code>tc-redirect-tap</code></a>
plugin. Two areas where my requirements are different are the jailer
and persistent IP addressing.</p>
<p>Because I may end up with some VMs exposed to the internet, I want to
tighten up their isolation using the
<a href="https://github.com/firecracker-microvm/firecracker/blob/main/docs/jailer.md">jailer</a>. The
jailer runs in a network namespace and containerizes itself by
unsharing its PID namespace and running in a pivot root. (That's
right, it's a VM running in a container!)</p>
<p>I'd like for VM IPs to be persistent so that I can register DNS
entries for their services and set up any forwarding rules I need at
the router. These need to persist across reboots of the underlying
host.</p>
<p>So I built on top of Evans' and Gruchalski's approaches by adding
support for the jailer and ensuring that I can have persistent IP
addresses, and of course the extra bits that need to happen to make
these IPs routable on my LAN. I wrapped this all up in a control
script I'm calling
<a href="https://gist.github.com/tgross/8aa33b65cba1850ebe430f33fafd6e41"><code>vmctl</code></a>
which gets invoked as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vmctl create --id <span style="font-weight:bold">$(</span>uuidgen<span style="font-weight:bold">)</span> --template ./vmconfigs/example.json
</span></span></code></pre></div><p>This creates a network namespace named after the <code>$id</code> and runs the
CNI plugins to allocate an IP address from the network bridge and
create a tuntap device. The output from CNI gets saved as a JSON file
to disk, so that if we run <code>vmctl create</code> again with the same <code>$id</code> we
can look for that file, skip creating the network, and reuse the same
IP address. Next <code>vmctl</code> creates a chroot containing the kernel and
root filesystem for the VM, and starts up the jailer. The jailer
isolates itself, drops privileges, and exec's into the Firecracker
process to boot the VM.</p>
<p>(Aside: <code>vmctl</code> is pronounced &quot;vm-cuddle&quot;. Obviously.)</p>
<h2 id="bridge-interface">Bridge Interface</h2>
<p>I have an Ansible template that looks something like the following,
where <code>{{ prefix }}</code> gets rendered with a &quot;subnet prefix&quot; for each of
the three physical machines. For example, one machine's prefix is
<code>&quot;192.168.30&quot;</code>, which gets rendered as an IP of <code>192.168.30.1/24</code> with
an IP range of <code>192.168.30.2</code> to <code>192.168.30.254</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>&lt;network&gt;
</span></span><span style="display:flex;"><span>  &lt;name&gt;default&lt;/name&gt;
</span></span><span style="display:flex;"><span>  &lt;bridge name=<span style="color:#666;font-style:italic">&#39;virbr0&#39;</span> stp=<span style="color:#666;font-style:italic">&#39;on&#39;</span> delay=<span style="color:#666;font-style:italic">&#39;0&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>  &lt;forward mode=<span style="color:#666;font-style:italic">&#39;route&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>  &lt;ip address=<span style="color:#666;font-style:italic">&#39;{{ prefix }}.1&#39;</span> netmask=<span style="color:#666;font-style:italic">&#39;255.255.255.0&#39;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;dhcp&gt;
</span></span><span style="display:flex;"><span>      &lt;range start=<span style="color:#666;font-style:italic">&#39;{{ prefix }}.2&#39;</span> end=<span style="color:#666;font-style:italic">&#39;{{ prefix }}.254&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>    &lt;/dhcp&gt;
</span></span><span style="display:flex;"><span>  &lt;/ip&gt;
</span></span><span style="display:flex;"><span>&lt;/network&gt;
</span></span></code></pre></div><p>A handler in the Ansible role configures this bridge as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>virsh net-define ./virbr0.xml
</span></span><span style="display:flex;"><span>virsh net-autostart default
</span></span><span style="display:flex;"><span>virsh net-start default
</span></span></code></pre></div><p>And that results in a bridge interface named <code>virbr0</code> with the IP
<code>192.168.30.1/24</code> on our example machine.</p>
<h2 id="cni">CNI</h2>
<p>Next I have a CNI configuration file in <code>/etc/cni/net.d</code>. When CNI
invokes this configuration, it creates the bridge if it doesn't exist
(although we've already created it for the QEMU VMs above). It then
allocates an IP address from the given range. Note that the range
starts at <code>192.168.30.32</code> so that I have some room at the bottom for
the existing QEMU VMs. Next it sets up the appropriate iptables
ingress rules, and creates a tuntap device.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;name&#34;: <span style="color:#666;font-style:italic">&#34;firecracker&#34;</span>,
</span></span><span style="display:flex;"><span>  &#34;cniVersion&#34;: <span style="color:#666;font-style:italic">&#34;0.4.0&#34;</span>,
</span></span><span style="display:flex;"><span>  &#34;plugins&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;type&#34;: <span style="color:#666;font-style:italic">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;name&#34;: <span style="color:#666;font-style:italic">&#34;firecracker-bridge&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;bridge&#34;: <span style="color:#666;font-style:italic">&#34;virbr0&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;ipam&#34;: {
</span></span><span style="display:flex;"><span>        &#34;type&#34;: <span style="color:#666;font-style:italic">&#34;host-local&#34;</span>,
</span></span><span style="display:flex;"><span>        &#34;resolvConf&#34;: <span style="color:#666;font-style:italic">&#34;/etc/resolv.conf&#34;</span>,
</span></span><span style="display:flex;"><span>        &#34;dataDir&#34;: <span style="color:#666;font-style:italic">&#34;/srv/vm/networks&#34;</span>,
</span></span><span style="display:flex;"><span>        &#34;subnet&#34;: <span style="color:#666;font-style:italic">&#34;192.168.30.0/24&#34;</span>,
</span></span><span style="display:flex;"><span>        &#34;rangeStart&#34;: <span style="color:#666;font-style:italic">&#34;192.168.30.32&#34;</span>,
</span></span><span style="display:flex;"><span>        &#34;gateway&#34;: <span style="color:#666;font-style:italic">&#34;192.168.30.1&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;type&#34;: <span style="color:#666;font-style:italic">&#34;firewall&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;type&#34;: <span style="color:#666;font-style:italic">&#34;tc-redirect-tap&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The CNI plugin is running as root inside the network namespace, before
we start the jailer. But the tuntap device will be opened by the
unprivileged Firecracker process the jailer starts. CNI plugin authors
understandably focus on the use case of K8s, so it took me a bit of
digging to figure out how to get the <code>tc-redirect-tap</code> plugin to
create a device accessible to the jailer user. There are undocumented
arguments to set the user ID, group ID, and tap name. The
<a href="https://www.cni.dev/docs/cnitool/"><code>cnitool</code></a> doesn't accept
arbitrary arguments for plugins but does accept a <code>CNI_ARGS</code>
environment variable. These arguments get passed to <em>every</em> plugin in
a chain of plugins, so you need to pass another argument
<code>IgnoreUnknown=1</code> that by convention the plugin authors are supposed
to respect. The resulting <code>vmctl</code> code looks something like the
following (some error handling and setting the <code>$uid</code> and <code>$gid</code> of
the jailer user have been elided for brevity).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="font-weight:bold">if</span> [ ! -f <span style="color:#666;font-style:italic">&#34;/var/run/netns/</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">id</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span> ]; <span style="font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    sudo ip netns add <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$id</span><span style="color:#666;font-style:italic">&#34;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># I&#39;ve named the device tap1 because the default is tap0</span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># and it makes it easier to verify args have been passed</span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># through to the CNI plugin correctly; we can reuse the</span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># name safely because each device ends up in its own netns</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span>=<span style="color:#666;font-style:italic">&#34;IgnoreUnknown=1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span>=<span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">;TC_REDIRECT_TAP_UID=</span><span style="color:#666;font-weight:bold;font-style:italic">$uid</span><span style="color:#666;font-style:italic">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span>=<span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">;TC_REDIRECT_TAP_GID=</span><span style="color:#666;font-weight:bold;font-style:italic">$gid</span><span style="color:#666;font-style:italic">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span>=<span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">cniArgs</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">;TC_REDIRECT_TAP_NAME=tap1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">result</span>=<span style="font-weight:bold">$(</span>sudo <span style="color:#666;font-weight:bold;font-style:italic">CNI_PATH</span>=<span style="color:#666;font-style:italic">&#34;/opt/cni/bin&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>              <span style="color:#666;font-weight:bold;font-style:italic">NETCONFPATH</span>=<span style="color:#666;font-style:italic">&#34;/etc/cni/net.d&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>              <span style="color:#666;font-weight:bold;font-style:italic">CNI_ARGS</span>=<span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$cniArgs</span><span style="color:#666;font-style:italic">&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>              cnitool add firecracker <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>              <span style="color:#666;font-style:italic">&#34;/var/run/netns/</span><span style="color:#666;font-weight:bold;font-style:italic">$id</span><span style="color:#666;font-style:italic">&#34;</span><span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># we don&#39;t pipe the cnitool straight into the file because</span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># we want to return early if we get an error without writing</span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># this file that we use to check for idempotency</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$result</span><span style="color:#666;font-style:italic">&#34;</span> | sudo tee <span style="color:#666;font-style:italic">&#34;/srv/vm/networks/</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">id</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">.json&#34;</span>
</span></span></code></pre></div><p>The <code>firecracker</code> argument to the <code>add</code> subcommand refers to the name
of the CNI configuration.</p>
<h2 id="firecracker-configuration">Firecracker Configuration</h2>
<p>The next step for <code>vmctl</code> is to create the chroot environment for the
jailer and to create a Firecracker configuration file from the
<code>$template</code> argument. A minimal template looks like the following JSON
file.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;boot-source&#34;: {
</span></span><span style="display:flex;"><span>    &#34;kernel_image_path&#34;: <span style="color:#666;font-style:italic">&#34;vmlinux-5.8&#34;</span>,
</span></span><span style="display:flex;"><span>    &#34;boot_args&#34;: <span style="color:#666;font-style:italic">&#34;console=ttyS0 reboot=k panic=1 pci=off&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  &#34;drives&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;drive_id&#34;: <span style="color:#666;font-style:italic">&#34;rootfs&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;path_on_host&#34;: <span style="color:#666;font-style:italic">&#34;alpine-rootfs.ext4&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;machine-config&#34;: {
</span></span><span style="display:flex;"><span>    &#34;vcpu_count&#34;: 1,
</span></span><span style="display:flex;"><span>    &#34;mem_size_mib&#34;: 512
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  &#34;network-interfaces&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;iface_id&#34;: <span style="color:#666;font-style:italic">&#34;eth0&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;guest_mac&#34;: <span style="color:#666;font-style:italic">&#34;$MAC&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;host_dev_name&#34;: <span style="color:#666;font-style:italic">&#34;$TAP&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For the kernel, initrd, and any drives, <code>vmctl</code> looks for the file in
a well-known location, creates a hardlink from there to the
jailer's chroot, and ensures the target is owned by the jailer user
and group. In this example, <code>/srv/vm/kernels/vmlinux-5.8</code> will be
hardlinked to <code>/srv/vm/jailer/$id/root/vmlinux-5.8</code>.</p>
<p>The template file is rendered with the CNI configuration. We get the
MAC address, append an <code>ip</code> argument to the boot arguments, and do
some fairly gross things with <code>jq</code> to write that configuration to
<code>/srv/vm/configs/$id.json</code>. That configuration is hardlinked to the
chroot at <code>/srv/vm/jailer/$id/root/config.json</code> and owned by root.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#888;font-style:italic"># read from the CNI ouput</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">netcfg</span>=<span style="color:#666;font-style:italic">&#34;/srv/vm/networks/</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">id</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">.json&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">ip</span>=<span style="font-weight:bold">$(</span>jq -r <span style="color:#666;font-style:italic">&#39;.ips[0].address | rtrimstr(&#34;/24&#34;)&#39;</span> &lt; <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$netcfg</span><span style="color:#666;font-style:italic">&#34;</span><span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">gateway_ip</span>=<span style="font-weight:bold">$(</span>jq -r <span style="color:#666;font-style:italic">&#39;.ips[0].gateway&#39;</span> &lt; <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$netcfg</span><span style="color:#666;font-style:italic">&#34;</span><span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">mac</span>=<span style="font-weight:bold">$(</span>jq -r <span style="color:#666;font-style:italic">&#39;.interfaces[] | select(.name == &#34;eth0&#34;).mac&#39;</span> &lt; <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$netcfg</span><span style="color:#666;font-style:italic">&#34;</span><span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">mask</span>=<span style="color:#666;font-style:italic">&#34;255.255.255.0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># shorten the uuid to something reasonable</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">hostname</span>=<span style="font-weight:bold">$(</span><span style="font-weight:bold;font-style:italic">echo</span> <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$id</span><span style="color:#666;font-style:italic">&#34;</span> | tr -d <span style="color:#666;font-style:italic">&#39;-&#39;</span> | head -c 16<span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># capture the args from the template</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">boot_args</span>=<span style="font-weight:bold">$(</span>jq -r <span style="color:#666;font-style:italic">&#39;.&#34;boot-source&#34;.boot-args&#39;</span> &lt; <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$template</span><span style="color:#666;font-style:italic">&#34;</span><span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># append our ip configuration:</span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># guest-ip:[server-ip]:gateway-ip:netmask:hostname:iface:state</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">boot_args</span>=<span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">boot_args</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic"> ip=</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">ip</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">::</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">gateway_ip</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">:</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">mask</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">:</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">hostname</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">:eth0:off&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"># render the template</span>
</span></span><span style="display:flex;"><span>jq <span style="color:#666;font-style:italic">&#34;(.\&#34;boot-source\&#34;.boot_args) |= \&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$boot_args</span><span style="color:#666;font-style:italic">\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic">    | (.\&#34;network-interfaces\&#34;[0].guest_mac) |= \&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$mac</span><span style="color:#666;font-style:italic">\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic">      &#34;</span> &lt; <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$template</span><span style="color:#666;font-style:italic">&#34;</span> | <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>          sudo tee <span style="color:#666;font-style:italic">&#34;/srv/vm/config/</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">id</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">.json&#34;</span>
</span></span></code></pre></div><p>Lastly <code>vmctl</code> ties this all together by invoking jailer like I've
shown below. To get the <code>firecracker</code> binary I need to use <code>readlink</code>
so that I can chase a symlink from <code>/usr/local/bin</code> to my local build
from source.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo jailer <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --id <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$id</span><span style="color:#666;font-style:italic">&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --daemonize <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --exec-file <span style="font-weight:bold">$(</span>readlink <span style="font-weight:bold">$(</span>which firecracker<span style="font-weight:bold">))</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --uid <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$uid</span><span style="color:#666;font-style:italic">&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --gid <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$gid</span><span style="color:#666;font-style:italic">&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --chroot-base-dir <span style="color:#666;font-style:italic">&#34;/srv/vm/jailer&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --netns <span style="color:#666;font-style:italic">&#34;/var/run/netns/</span><span style="color:#666;font-weight:bold;font-style:italic">$id</span><span style="color:#666;font-style:italic">&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --new-pid-ns <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     -- <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --config-file <span style="color:#666;font-style:italic">&#34;config.json&#34;</span>
</span></span></code></pre></div><h2 id="stopping-a-vm">Stopping a VM</h2>
<p>To stop one of the VMs without destroying it entirely, I need to send
it a graceful shutdown, and then clean up the runtime files in the
jailer's chroot. The next time I create the VM, <code>vmctl</code> will see that
we already have the network, VM configuration, and hardlinks in place
and will skip to calling jailer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">jail</span>=<span style="color:#666;font-style:italic">&#34;/srv/vm/jailer/firecracker/</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">id</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/root&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">pid</span>=<span style="font-weight:bold">$(</span>sudo cat <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">jail</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/firecracker.pid&#34;</span><span style="font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo curl <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     --unix-socket <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">jail</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/run/firecracker.socket&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     -H <span style="color:#666;font-style:italic">&#34;accept: application/json&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     -H <span style="color:#666;font-style:italic">&#34;Content-Type: application/json&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     -X PUT <span style="color:#666;font-style:italic">&#34;http://localhost/actions&#34;</span> <span style="color:#666;font-style:italic">\
</span></span></span><span style="display:flex;"><span><span style="color:#666;font-style:italic"></span>     -d <span style="color:#666;font-style:italic">&#34;{ \&#34;action_type\&#34;: \&#34;SendCtrlAltDel\&#34; }&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">while</span> :
</span></span><span style="display:flex;"><span><span style="font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    ps <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-weight:bold;font-style:italic">$pid</span><span style="color:#666;font-style:italic">&#34;</span> &gt; /dev/null || <span style="font-weight:bold;font-style:italic">break</span>
</span></span><span style="display:flex;"><span>    sleep 1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">echo</span> -n <span style="color:#666;font-style:italic">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;font-style:italic">echo</span>
</span></span><span style="display:flex;"><span>sudo rm -r <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">jail</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/firecracker.pid&#34;</span>
</span></span><span style="display:flex;"><span>sudo rm -r <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">jail</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/dev&#34;</span>
</span></span><span style="display:flex;"><span>sudo rm -r <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">jail</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/run&#34;</span>
</span></span><span style="display:flex;"><span>sudo rm -r <span style="color:#666;font-style:italic">&#34;</span><span style="color:#666;font-style:italic">${</span><span style="color:#666;font-weight:bold;font-style:italic">jail</span><span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">/firecracker&#34;</span>
</span></span></code></pre></div><p>This doesn't currently handle cleaning up if the VM shuts itself down,
so I'll need to return to that at some point and also add a <code>vmctl stop</code> for all running VMs to the host machine's shutdown.</p>
<h2 id="routing">Routing</h2>
<p>Finally, we need to set up routing so that packets from the host or
other machines can reach the VMs. On each host we set forwarding,
which looks like the following Ansible tasks but you can also do via
ex. <code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.ip_forward
</span></span><span style="display:flex;"><span>    value: <span style="color:#666;font-style:italic">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>    reload: <span style="font-weight:bold">yes</span>
</span></span><span style="display:flex;"><span>  become: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.conf.all.forwarding
</span></span><span style="display:flex;"><span>    value: <span style="color:#666;font-style:italic">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>    reload: <span style="font-weight:bold">yes</span>
</span></span><span style="display:flex;"><span>  become: <span style="font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv6.conf.all.forwarding
</span></span><span style="display:flex;"><span>    value: <span style="color:#666;font-style:italic">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>    reload: <span style="font-weight:bold">yes</span>
</span></span><span style="display:flex;"><span>  become: <span style="font-weight:bold">true</span>
</span></span></code></pre></div><p>And then on the ISP's router, we set up routing rules. I've got a Fios
router here, so I go to the <code>#/advanced/routing</code> page and configure a
rule for each machine. The &quot;destination&quot; field is the subnet prefix
(ex. <code>192.168.30.0</code>), whereas the &quot;gateway&quot; field is the IP address of
the physical host for that subnet (ex. <code>192.168.1.101</code> for my laptop).</p>
<p>Now any machine on the LAN can reach any other machine on the LAN,
physical or virtual. And I can further configure port mapping in the
router to expose any of the machines to the public internet.</p>

</section>
<section class="meta">
  <section class="blocks">

  <a class="block" href="https://github.com/tgross" title="Visit my GitHub">
    <span class="ss-social-circle ss-octocat"></span>
    <div>Collaborate.</div>
  </a>

  <a class="block" href="mailto:tim+blog@0x74696d.com" title="Email me">
    <span class="ss-social-circle ss-mail"></span>
    <div>Communicate.</div>
  </a>

  <a class="block" href="/index.xml" rel="alternate" type="application/rss+xml" title="0x74696d RSS">
    <span class="ss-social-circle ss-rss"></span>
    <div>RSS.</div>
  </a>
  </section>

  <div class="disclaimer">
    <p>&copy; Timothy Gross</p>
    <p>Except where otherwise noted, content on this site is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">Creative Common Attribution-ShareAlike 4.0 International License</a>. All code content is licensed under the <a href="/LICENSE">MIT license</a>, unless an excerpt from a larger work under another license.</p>
  </div>
  <div style="clear: both"></div>

</section>

</body>
</html>
