<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Falling In and Out of Love<br/>with DynamoDB</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Falling In and Out of Love<br/>with DynamoDB</h1></header>
            
            <section><div style="position: absolute; bottom: 0">
<p>tim gross | @0x74696d</p>
<p>http://0x74696d.com/slides/falling-in-and-out-of-love-with-dynamodb.html</p>
</div></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              1/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Tim Gross</h1></header>
            
            <section><p><br/>
<br/>
<br/>
<img alt="logo-dramafever" width=800 src="./images/20130618/logo-dramafever.png"></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>I'm Tim Gross</li>
<li>I do DevOps and develop software infrastructure for DramaFever.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              2/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>DramaFever</h1></header>
            
            <section><p><img alt="DF-homepage" width=800 src="./images/20130618/dfhome.png"></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Online television network specializing in bringing curated foreign television</li>
<li>from places like East Asia and Latin America and Spain</li>
<li>to a mostly North American audience of about 5 million</li>
<li>with English and Spanish subtitles.</li>
<li>We're a startup headquartered in NYC with the technical team working out of Narberth PA.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              3/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>DramaFever, then</h1></header>
            
            <section><p><img alt="site architecture then" src="./images/20130618/arch-old.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Our core application is hosted on AWS.</li>
<li>When I started with DramaFever, the entire infrastructure was a bunch of Linux EC2 instances running Django and Apache and Memcached, backed by MySQL RDS.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              4/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Team, then</h1></header>
            
            <section><ul>
<li>2 full-stack developers</li>
<li>2 mobile developers</li>
<li>1 Flash developer</li>
<li>1 DevOps and back-end developer (hi!)</li>
<li>0 full-time operations</li>
<li>0 DBAs</li>
</ul></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              5/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>DramaFever, now</h1></header>
            
            <section><p><img alt="site architecture today" src="./images/20130618/arch-new.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>(some of this is near-term speculative, not real # of instances)</li>
<li>More complex architecture</li>
<li>Multiple internal services</li>
<li>DynamoDB</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              6/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Team, now</h1></header>
            
            <section><ul>
<li>5 full-stack developers</li>
<li>3 mobile developers</li>
<li>1 Flash developer</li>
<li>3 front-end developers</li>
<li>1 DevOps and back-end developer (hi!)</li>
<li>1 full-time operations</li>
<li>0 DBAs</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>More developers, hired an ops guy, no DBAs.</li>
<li>Offload operations for the database systems.  Which is why we run RDS despites its flaws.</li>
<li>DISCLAIMER: Any opinion I express here is about what works for us, our stack, and our team.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              7/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Falling In and Out of Love With DynamoDB</h1></header>
            
            <section><p><br/><br/>
<img alt="Falling in and Out of Love With DynamoDB" src="./images/20130618/title.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Application &amp; schema design</li>
<li>Operations &amp; cost control</li>
<li>Lessons learned</li>
<li>We bring stories to our users, I'm going to tell some stories</li>
<li>Everything you ever wanted to know about DynamoDB but were afraid to ask.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              8/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Neat stuff about Dynamo</h1></header>
            
            <section><p><br/></p>
<h2><em>Dynamo: Amazon's Highly Available Key-value Store</em></h2>
<p>http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/decandia07dynamo.pdf</p>
<p><br/></p>
<ul>
<li>Parallel operations</li>
<li>Designed for availability across multiple data centers</li>
<li>Pay-as-you-go means no upfront infrastructure costs</li>
<li>No* maintenance</li>
</ul></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              9/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Fan &amp; Follow</h1></header>
            
            <section><p><img alt="like button" src="./images/20130618/totallynotlike.png" /></p></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              10/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Fan &amp; Follow</h1></header>
            
            <section><p><img alt="not a like button" src="./images/20130618/totallynotlike_red.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Totally not "Like"  =)</li>
<li>New feature come up from the product team to allow users to "fan" and "follow" particular series, episodes, actors, or each other.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              11/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Fan &amp; Follow</h1></header>
            
            <section><p><img alt="graph database" src="./images/20130618/graph.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Trace relationships across arbitrary objects -- a graph database.</li>
<li>Users to Actors and Series ("Fan")</li>
<li>Users to Users ("Follow")</li>
<li>Be able to trace backwards</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              12/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Why Dynamo?</h1></header>
            
            <section><ul>
<li>Pay-as-you-go means no upfront infrastructure costs</li>
<li>Good use case for hierarchal hash-range key structure.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Unproven feature so pay-as-you-go is a good model.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              13/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Schema-less-ish</h1></header>
            
            <section><p>Table rows are referenced by primary key: a hash key or hash key + range key.</p>
<p><br/></p>
<pre><code>primary key   |               attributes
---------------------------------------------------------------
hash key      |  attribute  |  attribute  |  attribute, etc...


     primary key        |               attributes
--------------------------------------------------------------------------
hash key  |  range key  |  attribute  |  attribute  |  attribute, etc...
</code></pre>
<p><br/></p>
<ul>
<li>Keys can be numbers, strings, or binary blob.</li>
<li>Hash keys can be queried with API exactly or scanned with EMR.</li>
<li>Range keys can be queried with API using hash key + range key conditions.</li>
<li>Attributes are unstructured schemaless K/V pairs.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Keys and attributes can be numbers or strings or binary blobs.  Note no datetime.</li>
<li>Hash queried exact only (ex. no greater-than 20) or by scanning (usually with EMR).</li>
<li>Range queries with range key conditions (ex. exact, greater than, begins with, between, etc.) or by scanning.</li>
<li>Each row has attributes, which are unstructured K/V pairs.  Up until recently with the addition of Secondary Indexes, you couldn't query on these at all without a scan.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              14/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Hierarchal Keys</h1></header>
            
            <section><p>Hash keys and range keys have a parent-child relationship.</p>
<p><br/></p>
<p><img alt="range key sorting" src="./images/20130618/dynamo-hashrange.png" /></p>
<p><br/></p>
<p>Range keys are sorted, but only with the "bucket" of a given hash key.</p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Big gotcha is that the keys have to be queried together.</li>
<li>API queries allow hash-only query on a hash+range key (null BEGINS_WITH)</li>
<li>Range keys are sorted, but only within the "bucket" of a hash key. (Important later)</li>
<li>Can't ever say "give me all rows between A and B" without scanning.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              15/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Fan &amp; Follow</h1></header>
            
            <section><p><img alt="graph database" src="./images/20130618/graph.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Natural hierarchy of keys</li>
<li>Hash key is user you're asking about</li>
<li>range key to find which actors, series, etc. the user is a fan of</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              16/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Fan &amp; Follow</h1></header>
            
            <section><p><br/></p>
<pre><code>hash key                 |   range key
-------------------------------------------------------------
content_type.entity_id   |   FAN_OF.content_type.entity_id
content_type.entity_id   |   FANNED_BY.content_type.entity_id
</code></pre>
<p><br/></p>
<ul>
<li>Double-writes (happens a lot in DynamoDB)</li>
<li>Composite keys generally strings</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>"fanned by" is a separate row.</li>
<li>So for each write, you write twice.  This is idiomatic DynamoDB.</li>
<li>Note that these keys are all strings, so if you have Ints for IDs of the objects they're getting coerced to strings when combined into the key.</li>
<li>Range keys will frequently be strings so you can do BEGINS_WITH queries.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              17/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>How do you query this thing?</h1></header>
            
            <section><p>Querying can be done with API (Python library is <code>boto</code>):</p>
<p><br/></p>
<p>Which actors does this user follow?</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<span class="lineno">2</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">BEGINS_WITH</span><span class="p">(</span><span class="s">&#39;FAN_OF.Actor.&#39;</span><span class="p">))</span>
</pre></div>

<p><br/></p>
<p>Who are this actor's fans?</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">actor_id</span><span class="p">,</span>
<span class="lineno">2</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">BEGINS_WITH</span><span class="p">(</span><span class="s">&#39;FANNED_BY.User.&#39;</span><span class="p">)</span>
</pre></div>

</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>generator of rows where we can easily take out the Actor id</li>
<li>generator of rows where we can easily take out the User id</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              18/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>The Firehose</h1></header>
            
            <section><p><br/>
<img alt="The Firehose" src="./images/20130618/firehose.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Analytics "pings" from our video players (Flash and native mobile clients).</li>
<li>This data gets used to divvy up revenue among video assets</li>
<li>Lets us and content owners get paid</li>
<li>Core business function</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              19/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>The Firehose</h1></header>
            
            <section><p><img alt="traffic flow pre-DynamoDB" src="./images/20130618/traffic-preanalytics.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>But all that data was a) hitting the main Django application</li>
<li>b) after a bunch of pre-processing, getting written into MySQL RDS.</li>
<li>Giant append-only table of billions of rows, which isn't great.</li>
<li>Traffic was about 70% of the total number of requests to the application.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              20/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema, first attempt</h1></header>
            
            <section><p><br/></p>
<pre><code>hash key        | range key   |  attributes
--------------------------------------------------------
series.episode  | timestamp   |  a bunch of attributes
</code></pre>
<p><br/></p>
<ul>
<li>Given series &amp; episode, slice the range to get minutes streamed for a given period.</li>
<li>Want to query all series and episodes for monthly reports?  Execute full table scan with EMR.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>One consequence of this is that writing timeseries data is hard to get right.</li>
<li>Full table scan to get data on all properties for a given period.  Problem will grow over time as assets are added.  Has another problem that I'll get to later. (Hot keys.)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              21/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Re-design</h1></header>
            
            <section><h1>You will have this conversation:</h1>
<p><br/>
<blockquote></p>
<p>"Hey, you know in MongoDB you can..."</p>
<p>"Nope, hierarchal keys, remember?"
</blockquote>
<br/></p>
<h1>or this one:</h1>
<blockquote>

<p>"Well in Redis you can..."</p>
<p>"Nope, hierarchal keys, remember?"
</blockquote>
<br/></p>
<h1>Many, many, many times.</h1></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              22/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema, bad hack</h1></header>
            
            <section><p><br/></p>
<pre><code>hash key  | range key   |  attributes
------------------------------------------------------------------
day       | timestamp   |  series, episode, a bunch of attributes
</code></pre>
<p><br/></p>
<ul>
<li>Full scan but only over each day in your processing period, slice ranged within that.</li>
<li>Aggregate data for series, episode via EMR.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>You might try to hack around this like this</li>
<li>In this case, your scan will be for each day in your processing period (ex. at the time 1 month for us), and you can slice ranges that way.</li>
<li>You'll need to roll-up tables as you go and archive them.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              23/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema and provisioning</h1></header>
            
            <section><p><img alt="cloudwatch with bad throughput" src="./images/20130618/thruput-badhashkey.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>The problem with this came when we tested it.</li>
<li>The actual write throughput was 1/10th of what we provisioned. =(</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              24/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema and provisioning</h1></header>
            
            <section><p><img alt="bad key distribution" src="./images/20130618/dynamotalk-keydistribution-bad.png" /></p>
<p>Leaking abstraction!</p>
<ul>
<li>AWS spins up instances to accept provisioned throughput (exact number undocumented.)</li>
<li>Provisioned throughput distributed among these instances.</li>
</ul>
<p>Hot hash key --&gt; hot instance</p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>When you provision throughput, Amazon is spinning up N instances of whatever the underlying processes are.</li>
<li>Your provisioned throughput is distributed among these instances.</li>
<li>Rows are written to the instances based on the hash key, not the combined hash+range key. Duh, it's a hash, right?</li>
<li>With hot key, throughput will be (provisioned throughput / however many instances Amazon has provisioned).</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              25/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema and provisioning</h1></header>
            
            <section><p><img alt="good key distribution" src="./images/20130618/dynamotalk-keydistribution-good.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Avoiding hot hash keys is key to DynamoDB performance.</li>
<li>Division by provisioning means if you have a bad hash key you'll see diminishing returns on performance the higher you provision your throughput.</li>
<li>This was also the hidden problem with using series/episode as hash.</li>
<li>Plenty of key space, but too many hot writes (latest==popular).</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              26/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema and provisioning</h1></header>
            
            <section><p><img alt="read vs write costs" src="./images/20130618/cost-read-vs-write.png" /></p>
<ul>
<li>Key schema design == direct operational cost</li>
<li>Writes are at least 5x cost of reads.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Can be even more than that if your rows are more than 1KB in size:</li>
<li>a unit of read capacity gets you 1 consistent read of up to 4KB (or 2 eventually consistent reads)</li>
<li>whereas the write unit is for 1KB writes.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              27/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>So how the <code>fsck</code> do you do<br/>timeseries data?!</h1></header>
            
            <section><p><br/><br/></p>
<p>Amazon's recommended way:</p>
<p><br/></p>
<pre><code>hash key                  | range key    |  attributes
-----------------------------------------------------------------
timestamp + random token  | session ID   |  series, episode, etc.
</code></pre>
<p><br/></p>
<ul>
<li>4 character random timestamp is enough to get good hash distribution for writes</li>
<li>Reads with EMR only.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>To do timeseries data, Amazon's recommended way to do it is to add a random token to the end of the timestamp</li>
<li>4 characters is enough to get the hashs distributed over the instances.</li>
<li>You'll need to roll-up tables as you go and archive them.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              28/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Key schema and throughput</h1></header>
            
            <section><p>Cannot query timeseries data without doing EMR jobs.</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9999</span><span class="p">):</span>
<span class="lineno">3</span>     <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_timestamp</span><span class="p">)</span> <span class="o">%</span> <span class="n">i</span>
<span class="lineno">4</span>     <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
</pre></div>

<p><img alt="fault-tolerance" src="./images/20130618/fault-tolerance.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Don't do this.  This is terrible!  10000 round-trips!</li>
<li>This tightly couples the use of DynamoDB to EMR for that kind of data.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              29/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Cost control</h1></header>
            
            <section><p><img alt="traffic flow before batching" src="./images/20130618/traffic-prebatching.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>SQS + Workers + DynamoDB provisioning + EMR == $$$</li>
<li>Still hadn't solved the problem of all the load we were putting on our main application.</li>
<li>Costs started escalating.</li>
<li>Writing directly from web application --&gt; writing one row at a time.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              30/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Asynchronous workers</h1></header>
            
            <section><p><img alt="traffic flow with batch writes" src="./images/20130618/traffic-postanalytics.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Split off the analytics requests to different web servers (running async processes)</li>
<li>wrote to SQS, picked up by workers running async process</li>
<li>doing batch-reads from SQS to queue up a batch-write of up to 25 rows.</li>
<li>Dropped half our web servers and 70% of our workers.</li>
<li>Batch writing to DynamoDB is critical to good production throughput.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              31/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Goodbye, DynamoDB! <sniff></h1></header>
            
            <section><p><img alt="traffic flow post-DynamoDB" src="./images/20130618/traffic-postdynamo.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>(flip back to previous slide to mention EMR/BI)</li>
<li>Still had dependency on EMR.</li>
<li>Wanted to give BI on this system, so we started using Redshift.</li>
<li>Ultimately replaced this entire system with S3 logging hacks and Redshift.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              32/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Streamtracking</h1></header>
            
            <section><p><img alt="Streamtracking" src="./images/20130618/streamtracking.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Our premium users are treated to videos without advertisements.</li>
<li>We limit the number of simultaneous streams for a premium user</li>
<li>Reduce the risk of premium users sharing their account (revenue loss)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              33/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Streamtracking</h1></header>
            
            <section><ul>
<li>Wanted to implement tracking of this stream without causing a lot of write/read activity on MySQL.</li>
<li>Assumed most users are honest: DB activity would be mostly spurious.</li>
</ul></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              34/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema</h1></header>
            
            <section><p>For each check, if number of tokens exceeds limit, then shut off the oldest stream the next time it checks in. The video player then complains to the user.</p>
<p><br/></p>
<pre><code>hash key   | range key                  |  attributes
-----------------------------------------------------------------
user ID    | browser-identifying-GUID   |  timestamp
</code></pre>
<p><br/></p>
<ul>
<li>Plenty of user IDs to avoid hot keys</li>
<li>Product wanted tokens to be persistent for BI</li>
<li>Not bullet-proof but "good enough"</li>
</ul></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              35/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Throttling</h1></header>
            
            <section><p><img alt="throttled write throughput" src="./images/20130618/throttled.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>It was hard to accurately estimate actual throughput on this, because we didn't know what the #s were on check frequency.</li>
<li>We made an estimate and actual traffic was more than expected.</li>
<li>Writes to DynamoDB should be asynchronous</li>
<li>If you get throttled, you'll end up blocking the web thread.</li>
<li>We got occassionally throttled due to spikey loads, and it blocked the web thread.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              36/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>DynamoDB monitoring is terrible</h1></header>
            
            <section><p><img alt="poor cloudwatch monitoring" src="./images/20130618/dynamocloudwatch.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>The smallest resolution you can get on throughput is 5 minutes</li>
<li>Cloudwatch metrics often lag by 10-15 minutes</li>
<li>This means you can be throttled but your monitoring systems won't tell you until it's too late!</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              37/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>... but it was worse</h1></header>
            
            <section><p><img alt="useless units" src="./images/20130618/dynamocloudwatch-units.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Up until a couple months ago, the Cloudwatch metrics had a different scale of units vs time than the provisioning, and that scale was undocumented!</li>
<li>Turned out to be tied to the monitoring resolution -- 5 minutes.</li>
<li>"3000" in your Cloudwatch metric, that represented a throughput of 10 writes/second.</li>
<li>Cloudwatch metrics are still messed up, but at least the monitoring interface for DynamoDB will give you numbers in the same units you provision in now.</li>
<li>Pointed this out to DynamoDB guys, so I'm taking credit for it.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              38/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>YMMV</h1></header>
            
            <section><p><img alt="Nginx" src="./images/20130618/daily_nginx_requests.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>We have a load that varies 5x between morning and evenings.</li>
<li>"Prime time television" still exists on the web.</li>
<li>You may need to overprovision and then scale down once you understand the average load.</li>
<li>(Or do detailed load testing, but we never seem to do that.)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              39/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Semi-homemade auto-scaling</h1></header>
            
            <section><ul>
<li>DynamoDB API allows up to +100% provisioning adjustment per API call.</li>
<li>You have to wait for the call to complete!</li>
<li>Only get 2 negative adjustments in the same 24 hour period on a given table.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Load that varies requires active monitoring via API</li>
<li>drop at thresholds or at times of day</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              40/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Semi-homemade auto-scaling</h1></header>
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> <span class="n">dyconn</span><span class="o">=</span><span class="n">boto</span><span class="o">.</span><span class="n">connect_dynamodb</span><span class="p">(</span><span class="n">AWS_ACCESS_KEY_ID</span><span class="p">,</span><span class="n">AWS_SECRET_ACCESS_KEY</span><span class="p">)</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>  <span class="c">#check for raising limit</span>
<span class="lineno"> 4</span>     <span class="n">pMetric</span> <span class="o">=</span> <span class="n">Metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;Consumed&#39;</span><span class="p">,</span> <span class="s">&#39;Provisioned&#39;</span><span class="p">)</span>
<span class="lineno"> 5</span>     <span class="n">provo</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">list_metrics</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;TableName&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">},</span>
<span class="lineno"> 6</span>                            <span class="n">pMetric</span><span class="p">,</span>
<span class="lineno"> 7</span>                            <span class="s">&quot;AWS/DynamoDB&quot;</span><span class="p">)</span>
<span class="lineno"> 8</span>     <span class="n">threshold</span><span class="o">=</span><span class="n">provo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s">&#39;Sum&#39;</span><span class="p">,</span><span class="s">&#39;Count&#39;</span><span class="p">,</span><span class="mi">60</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Sum&#39;</span><span class="p">]</span>
<span class="lineno"> 9</span>     <span class="n">tperc</span><span class="o">=</span><span class="n">count</span><span class="o">/</span><span class="n">threshold</span>
<span class="lineno">10</span>     <span class="k">if</span> <span class="n">tperc</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">80</span><span class="p">:</span>
<span class="lineno">11</span>         <span class="n">provset</span><span class="p">[</span><span class="n">READ_CAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">dyconn</span><span class="o">.</span><span class="n">describe_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>\
<span class="lineno">12</span>                             <span class="p">[</span><span class="s">&#39;Table&#39;</span><span class="p">][</span><span class="n">PROVISIONED</span><span class="p">][</span><span class="n">READ_CAP</span><span class="p">]</span>
<span class="lineno">13</span>         <span class="n">provset</span><span class="p">[</span><span class="n">WRITE_CAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">dyconn</span><span class="o">.</span><span class="n">describe_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>\
<span class="lineno">14</span>                              <span class="p">[</span><span class="s">&#39;Table&#39;</span><span class="p">][</span><span class="n">PROVISIONED</span><span class="p">][</span><span class="n">WRITE_CAP</span><span class="p">]</span>
<span class="lineno">15</span>         <span class="n">provset</span><span class="p">[</span><span class="n">pMetric</span><span class="p">]</span><span class="o">=</span><span class="n">threshold</span><span class="o">*</span><span class="mf">1.2</span>
<span class="lineno">16</span>         <span class="n">table_name</span> <span class="o">=</span> <span class="n">dyconn</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
<span class="lineno">17</span>         <span class="n">dyconn</span><span class="o">.</span><span class="n">update_throughput</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span>
<span class="lineno">18</span>                                  <span class="n">provset</span><span class="p">[</span><span class="n">P_READ_CAP</span><span class="p">],</span>
<span class="lineno">19</span>                                  <span class="n">provset</span><span class="p">[</span><span class="n">P_WRITE_CAP</span><span class="p">])</span>
</pre></div>

</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Estimating in advance (if you can) is a better method</li>
<li>We schedule 2 drops in provisioned throughput</li>
<li>One at the end of East Coast primetime and another several hours later at the end of West Coast primetime. (checks metric first)</li>
<li>Don't start scaling up until the morning again.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              41/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Alas, poor Dynamo...</h1></header>
            
            <section><ul>
<li>Turns out users were even more honest than we expected.</li>
<li>Wasn't worth the added costs.</li>
<li>Replaced with an identical system that uses memcached for token storage.</li>
</ul></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              42/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>User History</h1></header>
            
            <section><p><br/><br/>
<img alt="User History" src="./images/20130618/userhistory.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Still had a lot of write pressure on the main database.</li>
<li>The biggest case of this is what we called UserEpisode and ContinueWatching.</li>
<li>Let the user resume watching a video where they left off.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              43/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>User History</h1></header>
            
            <section><p><img alt="traffic flow pre-DynamoDB" src="./images/20130618/traffic-preanalytics.png" /></p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Lots of INSERTS and UPDATES on a very large MySQL InnoDB table</li>
<li>heavily indexing due to all the queries we had to make on it</li>
<li>poor performance and lots of table locks.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              44/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>User History</h1></header>
            
            <section><ul>
<li>Pull it out of MySQL and into DynamoDB</li>
<li>Key design was complicated.</li>
<li>Requirement to read the data without EMR; need to query via API.</li>
<li>Be able to display user's history in aggregate, organized by series</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Need to tell what episode of a series was last watched</li>
<li>Get history organized by series.</li>
<li>Querying was never the problem on existing system, it was always write locks.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              45/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Key schema</h1></header>
            
            <section><p>User, series, and episode number make up the schema.</p>
<p><br/></p>
<pre><code> hash key  | range key             |  attributes
 ----------------------------------------------------------------------
 user      | series_id.episode_id  |  video timestamp, watched datetime
</code></pre></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              46/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Key schema</h1></header>
            
            <section><p>Easy to get where a user is in a given video.</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<span class="lineno">2</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">EXACT</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">episode</span><span class="p">)))</span>
</pre></div>

<p><br/></p>
<p>Easy to get all episodes for a series.
<br/></p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<span class="lineno">2</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">BEGINS_WITH</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">series</span><span class="p">,)))</span>
</pre></div>

<p><br/></p>
<p>Get most-recently watched for a Series is not too bad either.</p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>get all the episodes and sort by watched_datetime in the web process.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              47/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>But...</h1></header>
            
            <section><ul>
<li>Getting most-recently watched for multiple Series means getting user's entire history and grouping / sorting / iterating over it.</li>
<li>Alternate schemas that won't work: can't include the video timestamp or watched_datetime in the range_key, because then you can't update the value without finding the old row, removing it, and adding the new row.</li>
<li>Don't want to process in the web thread because biggest user histories would take multiple trips to the DB to get all the pages.</li>
</ul></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              48/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Multiple tables for same data</br>is idiomatic DynamoDB</h1></header>
            
            <section><p><br/></p>
<p>The Amazon-recommended way:</p>
<p><br/>
UserEpisode table</p>
<pre><code> hash key  | range key             |  attributes
 ----------------------------------------------------------------------
 user      | series_id.episode_id  |  video timestamp, watched datetime
</code></pre>
<p><br/>
MostRecentlyWatchedEpisode table</p>
<pre><code> hash key  | range key  |  attributes
 ----------------------------------------------------------------------
 user      | series_id  |  episode_id, video timestamp, watched datetime
</code></pre>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Gross, but most queries can be done with 1 read (max 2).</li>
<li>(Turns out we do the 2nd one way more)</li>
<li>Writes require 2 writes.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              49/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Querying</h1></header>
            
            <section><p>Where is this user in a given video?</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">table</span> <span class="o">=</span> <span class="n">UserEpisodeTable</span><span class="o">.</span><span class="n">get_table</span><span class="p">()</span>
<span class="lineno">2</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<span class="lineno">3</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">EXACT</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">episode</span><span class="p">)))</span>
</pre></div>

<p><br/></p>
<p>What is the most recently-watched episode for this user for this series?</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">table</span> <span class="o">=</span> <span class="n">MostRecentlyWatchedEpisode</span><span class="o">.</span><span class="n">get_table</span><span class="p">()</span>
<span class="lineno">2</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<span class="lineno">3</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">EXACT</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">series</span><span class="p">,)))</span>
</pre></div>

<p><br/></p>
<p>What are the most recently-watched episodes for this user for all series?</p>
<div class="highlight"><pre><span class="lineno">1</span> <span class="n">table</span> <span class="o">=</span> <span class="n">MostRecentlyWatchedEpisode</span><span class="o">.</span><span class="n">get_table</span><span class="p">()</span>
<span class="lineno">2</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<span class="lineno">3</span>                       <span class="n">range_key</span><span class="o">=</span><span class="n">BEGINS_WITH</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">))</span>
</pre></div>

</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>some of these are bad queries to begin with</li>
<li>last one is computationally expensive for large histories</li>
<li>we can't easily page-in results</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              50/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Another table?!</h1></header>
            
            <section><p><br/>
MostRecentlyWatchedSeries table</p>
<pre><code> hash key  | attributes
 ----------------------------------------
 user      | ordered list of series_ids
</code></pre>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Really gross, but most queries can be done with 1 read (max 2).</li>
<li>Lets us read in the series ids and then page from UserEpisode or MRWE as needed</li>
<li>Writes require 2 writes + 1 read + 1 optional write.</li>
<li>Secondary indexes would greatly improve this problem</li>
<li>They didn't exist when we designed this.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              51/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Migrations</h1></header>
            
            <section><p>Exporting via EMR can be done, but the production migration would be tough.</p>
<ul>
<li>Fast bulk uploading of data <em>to</em> DynamoDB is overly complicated.</li>
<li>You can use EMR from other DynamoDB tables</li>
<li>From MySQL or external source, you're building your own batch writer.</li>
</ul>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Concurrency for uploads is tough.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              52/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Batch uploads</h1></header>
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> <span class="kn">import</span> <span class="nn">csv</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">boto</span>
<span class="lineno"> 3</span> <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="lineno"> 7</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 8</span> <span class="sd">    This will be called by __main__ for each process in our Pool.</span>
<span class="lineno"> 9</span> <span class="sd">    Error handling and logging of results elided.</span>
<span class="lineno">10</span> <span class="sd">    Don&#39;t write production code like this!</span>
<span class="lineno">11</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">12</span>     <span class="n">conn</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">connect_dynamodb</span><span class="p">(</span><span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">MY_ID</span><span class="p">,</span>
<span class="lineno">13</span>                                  <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">MY_SECRET</span><span class="p">)</span>
<span class="lineno">14</span>     <span class="n">table</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s">&#39;my_table_name&#39;</span><span class="p">)</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="lineno">17</span>         <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="lineno">18</span>         <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">19</span>         <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
<span class="lineno">20</span>             <span class="n">dyn_row</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">new_item</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="s">&#39;{}&#39;</span><span class="p">,</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="lineno">21</span>                                      <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;series&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="lineno">22</span>                                               <span class="s">&#39;episode&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="lineno">23</span>                                               <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="lineno">24</span>                                               <span class="s">&#39;moddt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">})</span>
<span class="lineno">25</span>             <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dyn_row</span><span class="p">)</span>
</pre></div>

</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Dump the data you need to CSV</li>
<li>Read it in, but this would blow up memory, so...</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              53/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Batch uploads</h1></header>
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span>         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
<span class="lineno"> 2</span>             <span class="n">batch_items</span> <span class="o">=</span> <span class="n">items</span><span class="p">[:</span><span class="mi">25</span><span class="p">]</span>
<span class="lineno"> 3</span>             <span class="n">batch_list</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">new_batch_write_list</span><span class="p">()</span>
<span class="lineno"> 4</span>             <span class="n">batch_list</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">batch_items</span><span class="p">)</span>
<span class="lineno"> 5</span>             <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">batch_write_item</span><span class="p">(</span><span class="n">batch_list</span><span class="p">)</span>
<span class="lineno"> 6</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;UnprocessedItems&#39;</span><span class="p">]:</span>
<span class="lineno"> 7</span>                 <span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">25</span><span class="p">:]</span>
<span class="lineno"> 8</span>             <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 9</span>                 <span class="n">unprocessed</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ui</span><span class="p">[</span><span class="s">&#39;PutRequest&#39;</span><span class="p">][</span><span class="s">&#39;Item&#39;</span><span class="p">][</span><span class="s">&#39;user&#39;</span><span class="p">]</span>
<span class="lineno">10</span>                                 <span class="k">for</span> <span class="n">ui</span> <span class="ow">in</span>
<span class="lineno">11</span>                                 <span class="n">response</span><span class="p">[</span><span class="s">&#39;UnprocessedItems&#39;</span><span class="p">]</span>\
<span class="lineno">12</span>                                         <span class="p">[</span><span class="s">&#39;my_table_name&#39;</span><span class="p">]]</span>
<span class="lineno">13</span>             <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch_items</span><span class="p">:</span>
<span class="lineno">14</span>                 <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unprocessed</span><span class="p">:</span>
<span class="lineno">15</span>                     <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>

</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>We flush the queue of items to write once we get to 25 (max batch size)</li>
<li>Have to check return values b/c when you get throttled you need to retry those items</li>
<li>This creates a lot of malloc, but keeps total commit low.</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              54/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Batch uploads</h1></header>
            
            <section><div class="highlight"><pre><span class="lineno">1</span> <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">2</span>     <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;xaao&#39;</span><span class="p">,</span><span class="s">&#39;xabf&#39;</span><span class="p">,</span><span class="s">&#39;xabw&#39;</span><span class="p">,</span><span class="o">...</span> <span class="p">]</span>
<span class="lineno">3</span>     <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
<span class="lineno">4</span>     <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">write_data</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
</pre></div>

<p><br/>
For full source and notes, see:</p>
<h2><em>DynamoDB Batch Uploads</em></h2>
<p>http://0x74696d.com/posts/dynamodb-batch-uploads</p>
</section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <ul>
<li>Map a split file across multiple processes to greatly increase concurrency.</li>
<li>gevent is another good way to do this w/ Python (exc. GIL-contention)</li>
</ul>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              55/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Is DynamoDB the right tool<br/>for the job?</h1></header>
            
            <section><p><br/></p>
<ul>
<li>Poor key design --&gt; cost &amp; pain</li>
<li>Batch write with high concurrency</li>
<li>Use active monitoring and throughput estimation</li>
</ul>
<p><img alt="spork" src="./images/20130618/spork.png" /></p></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              56/57
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: falling-in-and-out-of-love-with-dynamodb.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Falling In and Out of Love<br/>with DynamoDB</h1></header>
            
            <section><div style="position: absolute; bottom: 0">
<p>tim gross | @0x74696d</p>
<p>http://0x74696d.com/slides/falling-in-and-out-of-love-with-dynamodb.html</p>
<p><i>These slides use `landslide`, press P to get presenter's notes</i></p>
</div></section>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="falling-in-and-out-of-love-with-dynamodb.md">falling-in-and-out-of-love-with-dynamodb.md</a>
            </aside>
            
            <aside class="page_number">
              57/57
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Falling In and Out of Love<br/>with DynamoDB</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">Tim Gross</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">DramaFever</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">DramaFever, then</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Team, then</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">DramaFever, now</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Team, now</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Falling In and Out of Love With DynamoDB</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Neat stuff about Dynamo</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Fan &amp; Follow</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">Fan &amp; Follow</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Fan &amp; Follow</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">Why Dynamo?</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Schema-less-ish</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">Hierarchal Keys</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Fan &amp; Follow</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Fan &amp; Follow</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">How do you query this thing?</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">The Firehose</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">The Firehose</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">Key schema, first attempt</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">Re-design</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Key schema, bad hack</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Key schema and provisioning</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">Key schema and provisioning</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">Key schema and provisioning</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Key schema and provisioning</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">So how the <code>fsck</code> do you do<br/>timeseries data?!</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">Key schema and throughput</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">Cost control</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">Asynchronous workers</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">Goodbye, DynamoDB! <sniff></a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">Streamtracking</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
      <tr id="toc-row-34">
        <th><a href="#slide34">Streamtracking</a></th>
        <td><a href="#slide34">34</a></td>
      </tr>
      
      
      <tr id="toc-row-35">
        <th><a href="#slide35">Key schema</a></th>
        <td><a href="#slide35">35</a></td>
      </tr>
      
      
      <tr id="toc-row-36">
        <th><a href="#slide36">Throttling</a></th>
        <td><a href="#slide36">36</a></td>
      </tr>
      
      
      <tr id="toc-row-37">
        <th><a href="#slide37">DynamoDB monitoring is terrible</a></th>
        <td><a href="#slide37">37</a></td>
      </tr>
      
      
      <tr id="toc-row-38">
        <th><a href="#slide38">... but it was worse</a></th>
        <td><a href="#slide38">38</a></td>
      </tr>
      
      
      <tr id="toc-row-39">
        <th><a href="#slide39">YMMV</a></th>
        <td><a href="#slide39">39</a></td>
      </tr>
      
      
      <tr id="toc-row-40">
        <th><a href="#slide40">Semi-homemade auto-scaling</a></th>
        <td><a href="#slide40">40</a></td>
      </tr>
      
      
      <tr id="toc-row-41">
        <th><a href="#slide41">Semi-homemade auto-scaling</a></th>
        <td><a href="#slide41">41</a></td>
      </tr>
      
      
      <tr id="toc-row-42">
        <th><a href="#slide42">Alas, poor Dynamo...</a></th>
        <td><a href="#slide42">42</a></td>
      </tr>
      
      
      <tr id="toc-row-43">
        <th><a href="#slide43">User History</a></th>
        <td><a href="#slide43">43</a></td>
      </tr>
      
      
      <tr id="toc-row-44">
        <th><a href="#slide44">User History</a></th>
        <td><a href="#slide44">44</a></td>
      </tr>
      
      
      <tr id="toc-row-45">
        <th><a href="#slide45">User History</a></th>
        <td><a href="#slide45">45</a></td>
      </tr>
      
      
      <tr id="toc-row-46">
        <th><a href="#slide46">Key schema</a></th>
        <td><a href="#slide46">46</a></td>
      </tr>
      
      
      <tr id="toc-row-47">
        <th><a href="#slide47">Key schema</a></th>
        <td><a href="#slide47">47</a></td>
      </tr>
      
      
      <tr id="toc-row-48">
        <th><a href="#slide48">But...</a></th>
        <td><a href="#slide48">48</a></td>
      </tr>
      
      
      <tr id="toc-row-49">
        <th><a href="#slide49">Multiple tables for same data</br>is idiomatic DynamoDB</a></th>
        <td><a href="#slide49">49</a></td>
      </tr>
      
      
      <tr id="toc-row-50">
        <th><a href="#slide50">Querying</a></th>
        <td><a href="#slide50">50</a></td>
      </tr>
      
      
      <tr id="toc-row-51">
        <th><a href="#slide51">Another table?!</a></th>
        <td><a href="#slide51">51</a></td>
      </tr>
      
      
      <tr id="toc-row-52">
        <th><a href="#slide52">Migrations</a></th>
        <td><a href="#slide52">52</a></td>
      </tr>
      
      
      <tr id="toc-row-53">
        <th><a href="#slide53">Batch uploads</a></th>
        <td><a href="#slide53">53</a></td>
      </tr>
      
      
      <tr id="toc-row-54">
        <th><a href="#slide54">Batch uploads</a></th>
        <td><a href="#slide54">54</a></td>
      </tr>
      
      
      <tr id="toc-row-55">
        <th><a href="#slide55">Batch uploads</a></th>
        <td><a href="#slide55">55</a></td>
      </tr>
      
      
      <tr id="toc-row-56">
        <th><a href="#slide56">Is DynamoDB the right tool<br/>for the job?</a></th>
        <td><a href="#slide56">56</a></td>
      </tr>
      
      
      <tr id="toc-row-57">
        <th><a href="#slide57">Falling In and Out of Love<br/>with DynamoDB</a></th>
        <td><a href="#slide57">57</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Exposé</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>